@inherits VirtualMachinesBase
@attribute [Authorize]

<style>
    .form-popup {
        display: none;
        position: fixed;
        right: 0;
        top: 102px;
        border: 3px solid #f1f1f1;
        z-index: 9;
        display: block
    }

    .form-container {
        max-width: 300px;
        min-width: 300px;
        padding: 10px;
        background-color: white;
    }

    .filter-badge {
        background-color: #f5f4f2;
        color: gray;
        border: black;
        font-size: 10px;
    }

        .filter-badge:hover {
            box-shadow: 0px 0px 5px 0px rgba(212,212,212,0.75);
            -webkit-box-shadow: 0px 0px 5px 0px rgba(212,212,212,0.75);
            -moz-box-shadow: 0px 0px 5px 0px rgba(212,212,212,0.75);
        }
</style>

<div class="@isModalActive">

    @if (isSubmitting)
    {
        <div class="spinner"></div>
    }

    @if (MachinesList == null)
    {
        <div class="spinner"></div>
    }
    else
    {
        <div @onclick="OpenFilter">
            <span class="oi oi-eye" aria-hidden="true" style="float:right; padding:7px;"></span>
        </div>
        @if (appliedFilters == 0)
        {
            <span class="badge rounded-pill filter-badge">All Results</span>
        }
        else
        {
            if (filter != null)
            {
                if (filter.MachinePurpose != "Any")
                {
                    <span class="badge rounded-pill filter-badge">@filter.MachinePurpose</span>
                }
                if (filter.NoOfProcessors != "Any")
                {
                    <span class="badge rounded-pill filter-badge">@filter.NoOfProcessors</span>
                }
            }
        }
        <br />
        @if (message != "")
        {
            <p class="error-info">@message</p>
        }
        @if (notification != "")
        {
            <div class="alert alert-success">
                @notification
                <span style="float:right">
                    <button type="button" class="close icon-button" @onclick="clearNotification">
                        <span aria-hidden="true">X</span>
                    </button>
                </span>
            </div>
        }
        <div class="data-table">
            <table class="table table-striped table-borderless">
                <thead style="background:#1687A7; color:white">

                    <tr>
                        <th>
                            Id
                        </th>
                        <th>
                            Name
                        </th>

                        <th>
                            Status/Owner
                        </th>
                        <th>
                            From - To
                        </th>
                        <th>
                            Purpose
                        </th>
                        <th style="max-width:150px;">
                            Comments
                        </th>
                        <th>
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in MachinesList)
                    {
                        @if (item != null)
                        {
                            <tr>
                                <td>
                                    @item.AgentId
                                </td>
                                <td>
                                    <a href="/@item.AgentId/@item.Name/Capability">
                                        @item.Name
                                    </a>
                                </td>

                                @if (item.Status == "Available")
                                {
                                    <td>
                                        Available
                                    </td>
                                }
                                else
                                {
                                    <td>
                                        @item.UserName
                                    </td>
                                }

                                @if (item.Status == "Available")
                                {
                                    <td>   Available </td>
                                }
                                else
                                {
                                    <td>
                                        @item.FromTime?.ToString("MMM dd yyyy, h:mm tt")<br />
                                        @item.EndTime?.ToString("MMM dd yyyy, h:mm tt")
                                    </td>
                                }
                                <td>
                                    @item.Purpose
                                </td>
                                <td style="max-width:150px;">
                                    @item.Comments
                                </td>
                                <td>
                                    @if (item.Purpose == "Automated")
                                    {
                                        <button class="btn btn-reserved btn-md" disabled>Reserved</button>
                                    }
                                    else if (item.Status == "Available")
                                    {
                                        <button class="btn btn-green btn-md" disabled="@isSubmitting" @onclick="() =>AssignMachine(item.Id)">Assign</button>
                                    }
                                    else
                                    {
                                        <AuthorizeView Roles="Admin">
                                            <Authorized>
                                                <button class="btn btn-red btn-md" disabled="@isSubmitting" @onclick="() =>RevokeMachine(item)">Revoke</button>
                                            </Authorized>
                                            <NotAuthorized>
                                                @if (item.UserName != context?.User?.Identity?.Name)
                                                {
                                                    <button class="btn btn-green btn-md" disabled> &nbsp;In&nbsp; Use &nbsp;</button>

                                                }
                                                else
                                                {
                                                    <button class="btn btn-red btn-md" disabled="@isSubmitting" @onclick="() =>RevokeMachine(item)">Checkout</button>
                                                }
                                            </NotAuthorized>
                                        </AuthorizeView>
                                    }
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    }
</div>
@if (isFilter && filter != null)
{
    <div class="form-popup">
        <form class="form-container" @onsubmit="ApplyFilter">

            <div class="form-group">
                <label asp-for="machinePurpose" class="control-label">Machine Purpose</label>
                <select asp-for="machinePurpose" class="form-control" @bind="@filter.MachinePurpose" @bind:event="oninput" required>
                    <option value="Any" selected>Any</option>
                    <option value="Used">Used</option>
                    <option value="Manual">Manual</option>
                    <option value="Support">Support</option>
                </select>
            </div>

            <div class="form-group">
                <label asp-for="NoOfProcessors" class="control-label">No of Processors <span class="muted-text" style="font-size:10px">(Default: Any)</span></label>
                <input asp-for="NoOfProcessors" class="form-control" @bind="@filter.NoOfProcessors" required />
            </div>

            <div>
                <br />
                <button type="button" class="btn btn-red btn-md" disabled="@isSubmitting" @onclick="CloseFilter">Cancel</button>
                <button class="btn btn-green btn-md" type="submit" disabled="@isSubmitting" data-dismiss="modal">Apply</button>
            </div>

        </form>
    </div>
}
@if (isAssign)
{
    <div class="modal" tabindex="-1" style="display:block" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@modalTitle</h5>
                    <button type="button" class="close icon-button" @onclick="closeModal">
                        <span aria-hidden="true">X</span>
                    </button>
                </div>
                <form @onsubmit="AssignToUser">
                    <div class="modal-body">
                        <div class="form-group">
                            <label asp-for="userId" class="control-label">Select User</label>
                            <select asp-for="userId" class="form-control" @bind="@userDet" @bind:event="oninput" required>
                                <option value="">choose from below</option>
                                @if (UsersList != null)
                                {
                                    @foreach (var _user in UsersList)
                                    {
                                        <option value="@_user.Id @_user.UserName">@_user.UserName</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="form-group">
                            <label asp-for="Comments" class="control-label">Comments</label>
                            <input asp-for="Comments" class="form-control" @bind="@comments" required />
                        </div>
                        <div class="form-group">
                            <label asp-for="endTime" class="control-label">End Time</label>
                            <input type="datetime-local" asp-for="endTime" class="form-control" @bind="@endTime" required />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary btn-md" type="submit" disabled="@isSubmitting" data-dismiss="modal">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}
